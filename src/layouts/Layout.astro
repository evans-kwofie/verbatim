---
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
}

const { title, description = 'Premium academic writing and thesis consulting for university students across Ghana.' } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&display=swap"
      rel="stylesheet"
    />

    <title>{title} — Verbatim</title>
    <meta name="view-transition" content="same-origin" />

    <!-- Prevent flash of page content before loader -->
    <style>
      .page-content { opacity: 0; }
      .page-content.loaded { opacity: 1; }
    </style>
  </head>
  <body class="min-h-screen bg-paper text-ink overflow-x-hidden">

    <!-- ═══ Preloader ═══ -->
    <div id="preloader" class="fixed inset-0 z-[9999] flex items-center justify-center">
      <!-- Two curtain panels (behind the text) -->
      <div id="curtain-left" class="absolute top-0 bottom-0 left-0 w-1/2 bg-paper"></div>
      <div id="curtain-right" class="absolute top-0 bottom-0 right-0 w-1/2 bg-paper"></div>

      <!-- Wordmark (above curtains) -->
      <div class="relative z-10 text-center">
        <h2 class="font-serif text-4xl md:text-6xl tracking-wider uppercase overflow-hidden">
          <span id="preloader-text" class="inline-block" style="transform: translateY(100%); opacity: 0;">
            Verbatim
          </span>
        </h2>
        <div id="preloader-line" class="mx-auto mt-6 h-px bg-accent" style="width: 0;"></div>
        <p id="preloader-tagline" class="font-sans text-small tracking-widest uppercase text-ink-light mt-4" style="opacity: 0;">
          Academic Excellence
        </p>
      </div>
    </div>

    <!-- ═══ Page Content (hidden until loader finishes) ═══ -->
    <div class="page-content">
      <!-- Custom cursor elements -->
      <div class="cursor-dot" aria-hidden="true"></div>
      <div class="cursor-outline" aria-hidden="true"></div>

      <!-- Ink bleed overlay for transitions -->
      <div class="ink-bleed-overlay" aria-hidden="true"></div>

      <Navigation />

      <main>
        <slot />
      </main>

      <Footer />
    </div>

    <!-- ═══ Preloader Script ═══ -->
    <script is:inline>
      (function () {
        var preloader = document.getElementById('preloader');
        var text = document.getElementById('preloader-text');
        var line = document.getElementById('preloader-line');
        var tagline = document.getElementById('preloader-tagline');
        var curtainLeft = document.getElementById('curtain-left');
        var curtainRight = document.getElementById('curtain-right');
        var pageContent = document.querySelector('.page-content');

        if (!preloader) return;

        // Lock scroll during preloader
        document.body.style.overflow = 'hidden';

        // Phase 1: Wordmark slides up
        setTimeout(function () {
          text.style.transition = 'transform 0.7s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.7s ease';
          text.style.transform = 'translateY(0)';
          text.style.opacity = '1';
        }, 200);

        // Phase 2: Line expands
        setTimeout(function () {
          line.style.transition = 'width 0.6s cubic-bezier(0.16, 1, 0.3, 1)';
          line.style.width = '120px';
        }, 500);

        // Phase 3: Tagline fades in
        setTimeout(function () {
          tagline.style.transition = 'opacity 0.4s ease';
          tagline.style.opacity = '1';
        }, 800);

        // Phase 4: Fade out text
        setTimeout(function () {
          text.style.transition = 'opacity 0.3s ease';
          text.style.opacity = '0';
          line.style.transition = 'opacity 0.3s ease';
          line.style.opacity = '0';
          tagline.style.transition = 'opacity 0.3s ease';
          tagline.style.opacity = '0';
        }, 1600);

        // Phase 5: Curtains slide apart + reveal page
        setTimeout(function () {
          curtainLeft.style.transition = 'transform 0.8s cubic-bezier(0.76, 0, 0.24, 1)';
          curtainLeft.style.transform = 'translateX(-100%)';

          curtainRight.style.transition = 'transform 0.8s cubic-bezier(0.76, 0, 0.24, 1)';
          curtainRight.style.transform = 'translateX(100%)';

          pageContent.style.transition = 'opacity 0.6s ease 0.2s';
          pageContent.classList.add('loaded');
        }, 1900);

        // Phase 6: Cleanup
        setTimeout(function () {
          preloader.style.display = 'none';
          document.body.style.overflow = '';
        }, 2800);
      })();
    </script>

    <!-- Custom cursor script -->
    <script is:inline>
      (function () {
        if (window.matchMedia('(pointer: coarse)').matches) return;

        const dot = document.querySelector('.cursor-dot');
        const outline = document.querySelector('.cursor-outline');
        if (!dot || !outline) return;

        let mouseX = 0;
        let mouseY = 0;
        let outlineX = 0;
        let outlineY = 0;

        document.addEventListener('mousemove', (e) => {
          mouseX = e.clientX;
          mouseY = e.clientY;
          dot.style.left = mouseX + 'px';
          dot.style.top = mouseY + 'px';
        });

        function animateOutline() {
          outlineX += (mouseX - outlineX) * 0.12;
          outlineY += (mouseY - outlineY) * 0.12;
          outline.style.left = outlineX + 'px';
          outline.style.top = outlineY + 'px';
          requestAnimationFrame(animateOutline);
        }
        animateOutline();

        document.addEventListener('mouseover', (e) => {
          if (e.target.closest('a, button, [role="button"], input, textarea, select, label')) {
            outline.classList.add('cursor-hover');
            dot.style.transform = 'translate(-50%, -50%) scale(1.5)';
          }
        });
        document.addEventListener('mouseout', (e) => {
          if (e.target.closest('a, button, [role="button"], input, textarea, select, label')) {
            outline.classList.remove('cursor-hover');
            dot.style.transform = 'translate(-50%, -50%) scale(1)';
          }
        });

        document.addEventListener('mouseleave', () => {
          dot.style.opacity = '0';
          outline.style.opacity = '0';
        });
        document.addEventListener('mouseenter', () => {
          dot.style.opacity = '1';
          outline.style.opacity = '1';
        });
      })();
    </script>

    <!-- Global scroll-reveal script -->
    <script is:inline>
      (function () {
        var items = document.querySelectorAll('[data-scroll-reveal]');
        if (!items.length) return;

        function updateReveal() {
          var viewportCenter = window.innerHeight / 2;

          items.forEach(function (item) {
            var rect = item.getBoundingClientRect();
            var itemCenter = rect.top + rect.height / 2;
            var distance = Math.abs(viewportCenter - itemCenter);
            var maxDistance = window.innerHeight * 0.6;
            var ratio = 1 - Math.min(distance / maxDistance, 1);

            // Opacity: nearest to center = full, farthest = dim
            var opacity = 0.08 + ratio * 0.92;
            item.style.opacity = opacity;
          });
        }

        window.addEventListener('scroll', updateReveal, { passive: true });
        window.addEventListener('resize', updateReveal);
        updateReveal();
      })();
    </script>

    <!-- View transition ink bleed script -->
    <script is:inline>
      document.addEventListener('astro:before-preparation', () => {
        const overlay = document.querySelector('.ink-bleed-overlay');
        if (overlay) {
          overlay.style.opacity = '1';
          overlay.classList.add('active');
        }
      });

      document.addEventListener('astro:after-swap', () => {
        const overlay = document.querySelector('.ink-bleed-overlay');
        if (overlay) {
          overlay.classList.remove('active');
          overlay.style.opacity = '0';
          overlay.style.clipPath = 'circle(0% at 50% 50%)';
        }
      });
    </script>
  </body>
</html>
